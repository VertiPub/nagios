#!/bin/bash
#
# Autogenerated by Chef. 
#
#  Created 2000-01-03 by jaclu@grm.se
#
# nagios-nrpe-server This shell script takes care of starting and stopping
#               nrpe.
#
# chkconfig: 2345 80 30
# description: nrpe is a daemon for a remote nagios server, \
#              running nagios plugins on this host.
# processname: nrpe
# config: /usr/local/nagios/etc/nrpe.cfg

# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Source function library
if [ -f /etc/rc.d/init.d/functions ]; then
. /etc/rc.d/init.d/functions
elif [ -f /etc/init.d/functions ]; then
. /etc/init.d/functions
elif [ -f /etc/rc.d/functions ]; then
. /etc/rc.d/functions
fi

# Source networking configuration.
. /etc/sysconfig/network

# Check that networking is up.
[ ${NETWORKING} = "no" ] && exit 0

RETVAL=0
PID_FILE=<%= node['nagios']['nrpe']['pidfile']  %>
NRPE_BIN=/usr/bin/nrpe
NRPE_CONF=<%= node['nagios']['nrpe']['conf_dir'] %>/nrpe.cfg
LOCK_FILE=/var/lock/subsys/nrpe
USER=<%= node['nagios']['user']  %>

start() {
  checkstatus

  if [[ $RETVAL -eq 0 ]]; then
    echo -n "NRPE already running"
    RETVAL=0
    return $RETVAL
  fi

  if [[ -e $LOCKFILE ]]; then
    echo -n "NRPE cannot start, another process has the lock. rm ${LOCK_FILE} to override"
    RETVAL=1
    return $RETVAL
  fi

  touch $LOCK_FILE

  echo -n $"Starting NRPE: "

  daemon --pidfile $PID_FILE $NRPE_BIN -c $NRPE_CONF -d

  RETVAL=$?

  if [ $RETVAL -ne 0 ]; then
    rm -f $PID_FILE $LOCK_FILE
  fi

  return $RETVAL
}

stop() {
  checkstatus 

  if [[ $RETVAL -ne 0 ]]; then
    echo -n "NRPE already stopped"
    rm -f $PID_FILE $LOCK_FILE
    RETVAL=0
    return $RETVAL
  fi

  echo -n $"Stopping NRPE: "

  kill `cat $PID_FILE`

  RETVAL=$?

  if [ $RETVAL -eq 0 ]; then
    rm -f $PID_FILE $LOCK_FILE
  fi

  return $RETVAL
}

restart() {
  stop
  start
}

checkstatus(){
  if [ ! -e $PID_FILE ]; then
    RETVAL=1
    return $RETVAL
  fi

  PID=`cat $PID_FILE`

  if [ "${PID}x" == "x" ]; then
     RETVAL=2
     return $RETVAL
  fi

  ps -p $PID > /dev/null

  if [ $? -ne 0 ]; then
    RETVAL=3
    return $RETVAL
  fi

  user=`ps -p ${PID} h -o%u`
  cmd=`ps -p ${PID} h -o%c`

  if [ "x${USER}" != "x${user}" ]; then
    RETVAL=4
    return $RETVAL 
  fi 

  if [ "xnrpe" != "x${cmd}" ]; then
    RETVAL=5
    return $RETVAL
  fi

  RETVAL=0
  return $RETVAL
}

case "$1" in
  start)
    start
    ;;
  stop)
    stop
    ;;
  status)
    checkstatus
    ;;
  restart)
    restart
    ;;
  *)
    echo -n $"Usage: $0 {start|stop|status|restart}"
    exit 1
esac

exit $RETVAL